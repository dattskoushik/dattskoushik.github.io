<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Building Batch Data Pipelines | Suchindra Koushik</title>
    <meta name="description" content="Designing maintainable batch processing systems with idempotency, error handling, and monitoring.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@400;500&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

    <!-- Oat UI -->
    <link rel="stylesheet" href="../assets/vendor/oat.min.css">
    <script src="../assets/vendor/oat.min.js" defer></script>

    <script src="../assets/js/theme.js"></script>

    <style>
        :root {
            /* Fonts */
            --font-serif: 'Roboto Slab', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;

            /* Spacing overrides if needed */
            --space-xl: 4rem;
            --space-lg: 2.5rem;
            --space-md: 1.5rem;
            --space-sm: 1rem;
        }

        /* Dark Theme (Default) */
        [data-theme="dark"] {
            --background: #0a0a0a;
            --foreground: #ededed;
            --card: #111111;
            --card-foreground: #ededed;
            --muted: #1f1f23;
            --muted-foreground: #a1a1aa;
            --border: #27272a;
            --primary: #ffffff;
            --primary-foreground: #000000;
            --secondary: #1f1f23;
            --secondary-foreground: #ededed;
            --accent: #ffffff;
            --accent-foreground: #000000;
            --ring: #27272a;
            --input: #1f1f23;
            /* Custom */
            --header-bg: rgba(10, 10, 10, 0.8);
            --code-bg: #1f1f23;
        }

        /* Light Theme */
        [data-theme="light"] {
            --background: #f4f4f5;
            --foreground: #18181b;
            --card: #ffffff;
            --card-foreground: #18181b;
            --muted: #e4e4e7;
            --muted-foreground: #52525b;
            --border: #e4e4e7;
            --primary: #000000;
            --primary-foreground: #ffffff;
            --secondary: #e4e4e7;
            --secondary-foreground: #18181b;
            --accent: #000000;
            --accent-foreground: #ffffff;
            --ring: #e4e4e7;
            --input: #ffffff;
            /* Custom */
            --header-bg: rgba(244, 244, 245, 0.8);
            --code-bg: #e4e4e7;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: var(--font-sans);
        }

        /* Header Styling */
        header.site-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--header-bg);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border);
            padding: var(--space-sm) 0;
        }

        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-weight: 700;
            text-decoration: none;
            color: var(--foreground);
        }

        nav.nav-links {
            display: flex;
            gap: var(--space-md);
            align-items: center;
        }

        nav.nav-links a {
            text-decoration: none;
            color: var(--muted-foreground);
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s;
        }
        nav.nav-links a:hover, nav.nav-links a.active {
            color: var(--foreground);
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--foreground);
            cursor: pointer;
            padding: 0;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            nav.nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                flex-direction: column;
                background: var(--background);
                border-bottom: 1px solid var(--border);
                padding: var(--space-md);
                gap: var(--space-sm);
            }
            nav.nav-links.active {
                display: flex;
            }
        }

        /* Footer */
        .site-footer {
            margin-top: var(--space-xl);
            padding: var(--space-lg) 0;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }
        .social-links {
            display: flex;
            gap: var(--space-sm);
        }
        .social-links a {
            color: var(--muted-foreground);
            text-decoration: none;
        }
        .social-links a:hover {
            color: var(--foreground);
        }

        /* Theme Toggle */
        #theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            margin-left: var(--space-sm);
            color: var(--foreground);
        }

        /* Typography overrides */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-serif);
            color: var(--foreground);
        }

        nav.nav-links a, .button, button {
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        body {
            line-height: 1.7;
        }

        code, pre {
            font-family: var(--font-mono);
        }

        /* Grid Utility */
        .grid-2-col {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }
        @media (min-width: 768px) {
            .grid-2-col {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Utility overrides */
        .text-muted {
            color: var(--muted-foreground);
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

</head>
<body data-theme="dark">

    <header class="site-header">
        <div class="container">
            <a href="../index.html" class="logo">Suchindra Koushik</a>
            <button class="mobile-menu-btn" aria-label="Toggle menu" aria-expanded="false">â˜°</button>
            <nav class="nav-links">
                <a href="../index.html" class="">Home</a>
                <a href="../blog/index.html" class="active">Writing</a>
                <a href="../projects.html" class="">Projects</a>
                <a href="../about.html" class="">About</a>
                <a href="../resume.html" class="">Resume</a>
                <button id="theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
            </nav>
        </div>
    </header>

    <main class="container" >

    <article style="max-width: 800px; margin: 0 auto; padding: var(--space-xl) 0;">
        <header style="margin-bottom: var(--space-lg);">
            <a href="index.html" class="text-muted" style="text-decoration: none; display: inline-block; margin-bottom: var(--space-sm);">&larr; Back to Writing</a>
            <div class="text-muted" style="margin-bottom: var(--space-sm); font-size: 0.875rem;">
                Data Engineering â€¢ 2024-01-15 â€¢ 8 min
            </div>
            <h1 style="margin-bottom: var(--space-md); font-size: 2.5rem; line-height: 1.2;">Building Batch Data Pipelines</h1>
        </header>

        <div class="post-content" style="font-size: 1.125rem; line-height: 1.7;">
            <p>Building a script to move data from A to B is easy. Building a system that moves data from A to B <em>reliably</em>, at scale, while handling network failures, bad data, and restarts without corruption? That is engineering.</p>
<p>In the world of batch processing (ETL), "Reliability" usually boils down to two properties: <strong>Resilience</strong> (not crashing when things go wrong) and <strong>Correctness</strong> (not duplicating or losing data when things go wrong).</p>
<p>This article explores the patterns required to sleep well at night while your pipelines run.</p>
<h2>The Fallacy of "Retry Loop"</h2>
<p>The naive approach to reliability is the retry loop.</p>
<pre><code class="language-python">def process_data(batch):
    try:
        insert_to_db(batch)
    except Exception:
        time.sleep(5)
        process_data(batch)  # Retry
</code></pre>
<p>This works for transient network blips. But what if the failure is caused by a "Poison Pill"â€”a specific record that triggers a parser error? Infinite retries. The pipeline stalls.</p>
<p>What if the failure happens <em>after</em> insertion but <em>before</em> acknowledgement? You retry and insert the data twice. Duplicate data.</p>
<h2>1. Idempotency: The Golden Rule</h2>
<p><strong>Idempotency</strong> means that applying an operation multiple times has the same result as applying it once. <code>f(f(x)) = f(x)</code>.</p>
<p>In data pipelines, this allows us to "replay" failed batches safely.</p>
<h3>Database Level Idempotency</h3>
<p>The most robust way to ensure idempotency is relying on the destination's primary key constraints.</p>
<pre><code class="language-sql">INSERT INTO daily_metrics (date, metric_id, value)
VALUES ('2023-10-27', 'active_users', 4500)
ON CONFLICT (date, metric_id)
DO UPDATE SET value = EXCLUDED.value;
</code></pre>
<p>This "Upsert" ensures that if we re-run the job for '2023-10-27', we verify the state rather than blindly appending.</p>
<h3>File Level Idempotency</h3>
<p>When writing to object storage (S3), we cannot "update" files. We must rely on deterministic naming.</p>
<p><strong>Bad:</strong> <code>s3://bucket/data/upload_timestamp.json</code> (Non-deterministic)<br />
<strong>Good:</strong> <code>s3://bucket/data/partition_date/batch_id.json</code> (Deterministic)</p>
<h2>2. Checkpointing and State Management</h2>
<p>For long-running batch jobs (e.g., processing a huge log file), you cannot afford to restart from line 1 if it fails at line 999,999. You need <strong>Checkpointing</strong>.</p>
<p>We can maintain a separate state store (Redis, DynamoDB, or a Postgres table) to track progress.</p>
<pre><code class="language-python"># Simplified Logic
last_processed_id = get_checkpoint(&quot;job_123&quot;)
records = fetch_source(after=last_processed_id)

for batch in chunk(records):
    process(batch)
    save_checkpoint(&quot;job_123&quot;, batch.last_id)
</code></pre>
<p>However, there is a race condition here. If <code>process(batch)</code> succeeds (writes to DB) but <code>save_checkpoint</code> fails (network error), the next run will re-process the batch.<br />
<strong>Solution:</strong> Atomic Commit. If the destination supports transactions (like Postgres), write the data AND the checkpoint in the same transaction.</p>
<h2>3. The Dead Letter Queue (DLQ)</h2>
<p>What do you do with bad data? If 1 row in a batch of 10,000 is malformed, should you fail the whole batch? Usually, no.</p>
<p>The pattern is to <strong>quarantine</strong> the bad data.</p>
<pre><code class="language-python">def process_batch(records):
    valid_records = []
    failed_records = []

    for record in records:
        try:
            validate(record)
            valid_records.append(record)
        except ValidationError as e:
            failed_records.append({&quot;data&quot;: record, &quot;error&quot;: str(e)})

    bulk_insert(valid_records)
    send_to_dlq(failed_records)
</code></pre>
<p>The DLQ (Dead Letter Queue) can be an S3 bucket or a separate queue. It allows the pipeline to proceed while preserving the evidence for debugging.</p>
<h2>Code Example: Robust Log Ingestion</h2>
<p>Let's look at a snippet inspired by a log ingestion system I built (see full code in <code>assets/code_reference/log-parser</code>).</p>
<p>We use <strong>Pydantic</strong> for strict validation at the edge. This ensures that "poison pills" are caught early, before they enter the database.</p>
<pre><code class="language-python">from pydantic import BaseModel, Field, ValidationError
from datetime import datetime
from enum import Enum

class LogSeverity(str, Enum):
    INFO = 'INFO'
    WARN = 'WARN'
    ERROR = 'ERROR'

class LogEntry(BaseModel):
    timestamp: datetime
    severity: LogSeverity
    module: str = Field(min_length=1)
    message: str

def parse_and_quarantine(raw_logs):
    valid = []
    quarantine = []

    for log_line in raw_logs:
        try:
            # Pydantic handles type coercion and validation
            parsed = parse_regex(log_line)
            entry = LogEntry(**parsed)
            valid.append(entry.dict())
        except ValidationError as e:
            quarantine.append({&quot;raw&quot;: log_line, &quot;error&quot;: e.errors()})

    return valid, quarantine
</code></pre>
<p>By segregating the data immediately, we protect the downstream analytical storage (Warehouse) from schema violations.</p>
<h2>4. Backfilling: The Time Travel Problem</h2>
<p>Pipelines don't just process <em>new</em> data. Often, business logic changes ("We need to calculate the metric differently"). You need to <strong>Backfill</strong> historical data.</p>
<p>This is where Idempotency pays off. If your pipeline is idempotent, a backfill is just "running the job for past dates".</p>
<p><strong>Key Strategy:</strong> Decouple "Execution Time" from "Data Time".<br />
Never use <code>datetime.now()</code> inside your transformation logic. Always pass the <code>data_date</code> as a parameter.</p>
<pre><code class="language-python"># BAD
def calculate_daily_revenue():
    today = datetime.now().date()
    ...

# GOOD
def calculate_daily_revenue(target_date: date):
    ...
</code></pre>
<p>This allows you to run <code>calculate_daily_revenue('2023-01-01')</code> regardless of the actual wall-clock time.</p>
<h2>Conclusion</h2>
<p>Reliable pipelines are boring. They don't crash on bad input; they just sidebar it. They don't double-count data on retries; they upsert. They don't fear restarts; they checkpoint.</p>
<p>As engineers, our job is to anticipate failure. By designing for idempotency and observability (DLQs), we build systems that recover automatically, allowing us to focus on the next interesting problem.</p>
        </div>
    </article>

    </main>

    <footer class="site-footer container">
        <div class="social-links">
            <a href="https://github.com/dattskoushik" target="_blank">GitHub</a>
            <a href="https://linkedin.com/in/suchindrakoushik" target="_blank">LinkedIn</a>
            <a href="https://instagram.com/dattskoushik" target="_blank">Instagram</a>
            <a href="mailto:suchindra.formal@outlook.com">Email</a>
        </div>
        <p class="copyright">&copy; <script>document.write(new Date().getFullYear())</script> Suchindra Koushik. All rights reserved.</p>
    </footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>

</body>
</html>